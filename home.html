<!doctype html>
<html>
  <head>
    <title>Reaction times of auditory take over requests</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="jspsych-5.0.3/jspsych.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-text.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-single-audio.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-multi-stim-multi-response.js"></script>
    <link href="jspsych-5.0.3/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body>
  </body>
  <script>

  /* define welcome message block */
  var welcome_block = {
    type: "text",
    text: "Welcome to the experiment. Press any key to begin."
  };

  /* define instructions block */
  var instructions_block = {
    type: "text",
    text: "<p>In this experiment, you will hear sounds. You need to press 'F' after hearing each sound as fast as possible. Your reaction times will be recorded. </p>",
    timing_post_trial: 2000
  };

  var post_trial_gap = function() {
    return Math.floor( Math.random() * 1500 ) + 750;
  }

  /* define test block */
  var test_stimuli = [
    {
      stimulus: 'sounds/beep_0ms.mp3',
      prompt: '<img src="img/circle_red.png" />',
      on_finish: function(data){
        jsPsych.data.addDataToLastTrial({type: "beep_0"});
      }
    },
    {
      stimulus: 'sounds/beep_500ms.mp3',
      prompt: '<img src="img/circle_middle.png" />',
      on_finish: function(data){
        jsPsych.data.addDataToLastTrial({type: "beep_500"});
      }
    },
    {
      stimulus: 'sounds/beep_1000ms.mp3',
      prompt: '<img src="img/circle_pink.png" />',
      on_finish: function(data){
        jsPsych.data.addDataToLastTrial({type: "beep_1000"});
      }
    }
  ];

  var all_trials = jsPsych.randomization.repeat(test_stimuli, 2);

  var audio_block = {
    type: 'single-audio',
    choices: ['F'],
    //timing_response: 5000,
    timing_post_trial: post_trial_gap,
    timeline: all_trials
  };
 

  var debrief_block = {
    type: "text",
    text: function() {
      return "<p>Thank you! Please remember the following number: " +
      String(Date.now()) +
      ". Press any key to complete the experiment and proceed to the page to finalise the HIT and receive money.</p>";
    }
  };

  /* create experiment timeline array */
  var timeline = [];
  timeline.push(welcome_block);
  timeline.push(instructions_block);
  timeline.push(audio_block);
  timeline.push(debrief_block);

  /* save data */
  function saveData(filename, filedata){
   $.ajax({
      type:'post',
      cache: false,
      url: 'save-data.php', // this is the path to the above PHP script
      data: {filename: filename, filedata: filedata}
   });
  }

  /* MTurk information */
  var turkInfo = jsPsych.turk.turkInfo();
  if(turkInfo.previewMode && !turkInfo.outsideTurk) {
    worker_id = turkInfo.workerId;
  } else {
    worker_id = String(Date.now());
  }
  timestamp = String(Date.now());

  jsPsych.pluginAPI.preloadImages(['img/stop_red.png'], function(){ preloadAudio(); });

  function preloadAudio () {
      jsPsych.pluginAPI.preloadAudioFiles(['sounds/beep_0ms.mp3', 'sounds/beep_500ms.mp3', 'sounds/beep_1000ms.mp3'], start);
  }

  /* Start the experiment */
  function start(){
    jsPsych.init({
      timeline: timeline,
      show_progress_bar: true,
      on_finish: function(data) {
        //jsPsych.data.displayData();
        saveData(worker_id.concat("_").concat(timestamp).concat(".csv"), jsPsych.data.dataAsCSV())
      }
    });
  }

</script>
</html>